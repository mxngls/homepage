#!/bin/sh

# Post-receive hook that runs automatically after GitHub Actions pushes to the
# bare repository at /home/private/repo.git on our server hosted via
# NearlyFreeSpeech.net.
#
# This script checks out the latest commit to a work tree, runs the build
# process (ensuring BSD compatibility), and copies the generated files to
# /home/public where they're served to visitors.
#
# The bare repo contains only git metadata, so we need a separate work tree at
# to actually build the site. This file should be placed at
# /home/private/repo.git/hooks/post-receive and made executable.

# Define paths
GIT_DIR="/home/private/repo.git"
WORK_TREE="/home/private/checked_out_repo"
PUBLIC_DIR="/home/public"

# Checkout the latest code
git --work-tree="$WORK_TREE" --git-dir="$GIT_DIR" checkout -f main

# Initialize and update submodules
cd "$WORK_TREE" && git --git-dir="$GIT_DIR" --work-tree="$WORK_TREE" submodule update --init --recursive

# Update the hook from the repo (self-update for next run)
cp "$WORK_TREE/post-receive" "$GIT_DIR/hooks/post-receive"

# Create .git file pointing to bare repo (allows builder to find files correctly)
# This mimics the structure created by git worktree, where .git is a file not a directory
echo "gitdir: $GIT_DIR" > "$WORK_TREE/.git"

# Navigate to work tree and build
# Now builder can use the default .git location
cd "$WORK_TREE" && ./build.sh

# Copy built files to public directory (using . [Glob] to include hidden files)
cp -r "$WORK_TREE/docs/." "$PUBLIC_DIR/"

# Write deployed commit hash for verification
git --git-dir="$GIT_DIR" rev-parse HEAD >"$PUBLIC_DIR/.deployed-commit"
